---
title: "sewage"
author: "Dan Weinberger"
date: "6/1/2020"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document: default
params:
  rerun_model: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(reshape2)
library(HDInterval)
library(rjags)
library(xtable)
library(sas7bdat)
library(pbapply)

source('./Models/mod1.deriv.ar1.R')
source('./Models/mod2.dist.lag.alt2.R')
source('./Models/mod2.indiv.lags.R')


```

## Overview
These are additional analyses of data examining increases in SARS-CoV-2 RNA concentrations in primary sewage sludge in relation to COVID-19 hospitalizations and cases. The original preprint, led by Jordan Peccia, et al can be found here: https://www.medrxiv.org/content/10.1101/2020.05.19.20105999v1 
The original pre-print included a correlation of smoothed versions of the viral RNA data and the epidemiological indicators. In the analyses presented here, we use an error-in-variables time series model to get an estimate of the underlying viral dynamics in sewage and the relationship of this with hospitalizations. This analysis is carried out in the Bayesian framework, allowing us to correctly quantify uncertainty in the estimated associations. These additional analyses were performed by Dan Weinberger (Epidemiology of Microbial Diseases, Yale School of Public Health), with input from Josh Warren (Biostatistics, Yale School of Public Health) and the rest of the original study team.

```{r, eval=F, include=F}
## Combine data (only need to do this once)

ds1 <- read_excel('./Data/raw RNA data.xlsx')
ds1.m <- melt(ds1, id.vars='DATE')
names(ds1.m) <- c('date', 'test','conc')



ds2 <- read.sas7bdat('./Data/dw1stpostest.sas7bdat')
ds2$date <-format(as.Date(ds2$newspecdate, origin="1960-01-01"),"%Y-%m-%d")

tests <- read.sas7bdat('./Data/dw1stcovtest.sas7bdat')
tests$date <-format(as.Date(tests$newspecdate, origin="1960-01-01"),"%Y-%m-%d")


ds2.nh <- ds2[ds2$OfficialCity %in% c('NEW HAVEN', 'EAST HAVEN','HAMDEN', 'WOODBRIDGE'),]
ds2.nh$pos.tests <-1
ds2.nh.agg <- aggregate(ds2.nh[,'pos.tests', drop=F],by=list('date'=ds2.nh$date), FUN=sum)
ds2.nh.agg$date <- as.Date(ds2.nh.agg$date)

tests.nh <- tests[tests$OfficialCity %in% c('NEW HAVEN', 'EAST HAVEN','HAMDEN', 'WOODBRIDGE'),]
tests.nh$cov.tests <-1
tests.nh.agg <- aggregate(tests.nh[,'cov.tests', drop=F],by=list('date'=tests.nh$date), FUN=sum)
tests.nh.agg$date <- as.Date(tests.nh.agg$date)


ds.hosp <- read_excel('./Data/epi.data.xlsx')
ds.hosp$date <- as.Date(ds.hosp$date)
ds1.m$date <- as.Date(ds1.m$date)

ds3 <- merge(ds2.nh.agg, ds1.m, by='date', all=T)
ds3 <- merge(ds3, tests.nh.agg, by='date', all=T)
ds3 <- merge(ds3, ds.hosp, by='date', all=T)
ds3$prop.pos <- ds3$pos.tests/ds3$cov.tests
#plot(ds3$pos.tests)
#points(ds3$new.pos.tests)

ds3$conc <- as.numeric(ds3$conc)
ds3$target <- 'n1'
ds3$target[grep('n1', ds3$test)] <- 'n2'

write.csv(ds3,'./Data/combined.data.csv')
```





```{r}
## read in combined data

ds3 <- read.csv('./Data/combined.data.csv')
ds3$date <- as.Date(ds3$date)
```


## Plots of raw data

This shows that one of the PCR targets is consistently higher than the other--will need to adjust for this in the model
```{r, fig.width=8, fig.height=13}
par(mfrow=c(4,2))
plot(ds3$date, (ds3$hospt_admit), type='l', bty='l', main='Hospitalizations', ylab=('Log(Hospitalizations (N))'))
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')

plot(ds3$date, log(ds3$hospt_admit), type='l', bty='l', main='Log Hospitalizations', ylab=('log(Hospitalizations (N))') )
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')


# plot(ds3$date, ds3$new.cases, type='l', main='New reported cases')

plot(ds3$date, (ds3$prop.pos), main='Proportion of human tests positive', xlab='Date', ylab='Proportion positive', bty='l' )
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')

plot(ds3$date, log(ds3$prop.pos/(1-ds3$prop.pos)), main='Logit(Proportion of human tests positive)', xlab='Date', ylab='Logit Proportion positive', bty='l')
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')



plot(ds3$date, (ds3$new.cases), main='New cases', col=as.factor(ds3$target), xlab='Date', ylab='Log Concentration', bty='l')
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')


plot(ds3$date, log(ds3$new.cases), main='log(New cases)', col=as.factor(ds3$target), xlab='Date', ylab='Log Concentration', bty='l')
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')

plot(ds3$date, (ds3$conc), main='Viral RNA in Sewage', col=as.factor(ds3$target), xlab='Date', ylab=' Concentration', bty='l')
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')


plot(ds3$date, log(ds3$conc), main='Viral RNA in Sewage', col=as.factor(ds3$target), xlab='Date', ylab='Log Concentration', bty='l')
abline(v=as.Date(c('2020-03-17','2020-03-24','2020-03-31','2020-04-07','2020-04-14','2020-04-21','2020-04-28')), lty=2, col='gray')


```


```{r}
## Prepare data for JAGS

ds.mod <- ds3[!(is.nan(ds3$conc)),]
ds.mod <- ds.mod[!(is.na(ds.mod$conc)),]

ds.mod$log.conc <- as.vector(log(ds.mod$conc))

ds.mod.m <- melt(ds.mod[,c('date','test','log.conc','hospt_admit')], id.vars=c('date', 'test'))
ds.mod.c <- dcast(ds.mod.m, date~variable+test, fun.aggregate = mean)
W1 <- ds.mod.c[, grep('log.conc', names(ds.mod.c))] 
W1 <- apply(W1, 2, function(x){
  x[is.nan(x)] <-NA
  return(x)
} )

scale.W1 <- apply(W1,2, scale)
Y1 <- ds.mod.c[,'hospt_admit_rep1_n1']
Y1[is.nan(Y1)] <-NA

W1.scale <- apply(W1,2,scale)

log.offset.y1 <- rep(0, length(Y1))

```

## Association between sewage concentration and epidemiological indicators
-We evaluate three epidemiological time series: COVID-19 hospitalizations, proportion of tests that are positive for coronavirus (based on date of test), and number of cases of covid-19 (based on date of report). 
-All of the plots show 98.75% credible intervals, which represent an alpha of 0.1, adjusted for multiple testing

### Association of sewage viral concentration at different lags with hospitalizations 

Test lags of 0-7 days, one at a time.

```{r, include=F, eval=params$rerun_model}
mods.hosp <- pblapply(c(0:7), function(zz) mod2.indiv.lag.func( Y=Y1, log.offset=log.offset.y1, W=W1.scale, lag.n=zz))
saveRDS(mods.hosp,'./results/mods.hosp.rds')
```
Rate ratio (+/- 90% Credible intervals)  showing the relative increase in positive tests associated with a 1-log increase of sewage RNA concentration at various lags (based on date of test). This shows the strongest association with a lag of 1 day (sewage increases firts, then hospitalizations a day later), with the effect trailing off with longer or shorter lags.

```{r}
mods.hosp <-
  readRDS('./results/mods.hosp.rds')
#Extract the betas
beta.hospt <- lapply(mods.hosp,'[[','beta1')
beta.hospt <- do.call('rbind.data.frame',beta.hospt)
irr.hospt <- exp(beta.hospt)
yrange <- range(irr.hospt)
plot(0:7, irr.hospt[,"post_means"], ylim=yrange, bty='l', ylab='Rate ratio', xlab='Lag (days)' , pch=16)
arrows(x0=0:7, y0=irr.hospt[,"lower"], y1=irr.hospt[,"upper"], length=0)
abline(h=1, lty=2, col='gray')
```



### Association of sewage viral concentration at different lags with new cases (defined by date of test)

```{r, eval=T}

#Note data on new cases are missing
#ds.mod.m <- melt(ds.mod[!is.na(ds.mod$new.cases),c('date','test','log.conc','new.cases')], id.vars=c('date', 'test'))
ds.mod.m <- melt(ds.mod[,c('date','test','log.conc','pos.tests', 'cov.tests')], id.vars=c('date', 'test'))
ds.mod.c <- dcast(ds.mod.m, date~variable+test, fun.aggregate = mean)
W2 <- ds.mod.c[, grep('log.conc', names(ds.mod.c))] 
W2 <- apply(W2, 2, function(x){
  x[is.nan(x)] <-NA
  return(x)
} )
scale.W2 <- apply(W2, 2, scale)
Y2 <- ds.mod.c[,'pos.tests_rep1_n1']
Y2[is.nan(Y2)] <-NA

log.offset2 <- log(ds.mod.c[,'cov.tests_rep1_n1'])
log.offset2[is.nan(log.offset2)] <-NA
log.offset2[is.na(log.offset2)] <-0
W2.scale <- apply(W2,2, scale)

```

```{r, eval=T, include=F, eval=params$rerun_model}
mods.cases.dx <- pblapply(c(0:7), function(zz) mod2.indiv.lag.func( Y=Y2, log.offset=log.offset2, W=W2.scale, lag.n=zz))
saveRDS(mods.cases.dx,'./results/mods.cases.dx.rds')

```
Rate ratio (+/- 90% Credible) showing the relative increase in positive tests associated with a 1-log increase of sewage RNA concentration at various lags (based on date of test). This shows the strongest association with a lag of 4 days (sewage increases first, then proportion of tests that were positive 4 days later), with uncertainty in the estimates and in the length of the lag. 

```{r}
mods.cases.dx <-
  readRDS('./results/mods.cases.dx.rds')
#Extract the betas
beta.dx <- lapply(mods.cases.dx,'[[','beta1')
beta.dx <- do.call('rbind.data.frame',beta.dx)
irr.dx <- exp(beta.dx)

yrange <- range(irr.dx)
plot(0:7, irr.dx[,"post_means"], ylim=yrange, bty='l', ylab='Rate ratio', xlab='Lag (days)' , pch=16)
arrows(x0=0:7, y0=irr.dx[,"lower"], y1=irr.dx[,"upper"], length=0)
abline(h=1, lty=2, col='gray')
```

### Association of sewage viral concentration at different lags with new cases (defined by date of report)

```{r, eval=T}

#Note data on new cases are missing
ds.mod.m <- melt(ds.mod[,c('date','test','log.conc','new.cases')], id.vars=c('date', 'test'))
ds.mod.c <- dcast(ds.mod.m, date~variable+test, fun.aggregate = mean)
W3 <- ds.mod.c[, grep('log.conc', names(ds.mod.c))] 
W3 <- apply(W3, 2, function(x){
  x[is.nan(x)] <-NA
  return(x)
} )
Y3 <- ds.mod.c[,'new.cases_rep1_n1']
Y3[is.nan(Y3)] <-NA

log.offset3 <- rep(1, length(Y3))
W3.scale <- apply(W3,2, scale)

```


```{r, eval=T, include=F, eval=params$rerun_model}
mods.cases.rep <- pblapply(c(0:7), function(zz) mod2.indiv.lag.func( Y=Y3, log.offset=log.offset3, W=W3.scale, lag.n=zz))
saveRDS(mods.cases.rep,'./results/mods.cases.rep.rds')

```

Rate ratio (+/- 90% Credible intervals) showing the relative increase in reported cases associated with a 1-log increase of sewage RNA concentration at various lags. This shows the strongest association with a lag of 1, 4, or 6 days (sewage increases first, then proportion of tests that were positive 1,4,or 6 days later), with considerable uncertainty in the estimates and in the length of the lag.
```{r}
mods.cases.rep <-
  readRDS('./results/mods.cases.rep.rds')

#Extract the betas
beta.rep <- lapply(mods.cases.rep,'[[','beta1')
beta.rep <- do.call('rbind.data.frame',beta.rep)
irr.rep <- exp(beta.rep)

yrange <- range(irr.rep)
plot(0:7, (irr.rep[,"post_means"]), ylim=yrange, bty='l', ylab='Rate ratio', xlab='Lag (days)' , pch=16)
arrows(x0=0:7, y0=irr.rep[,"lower"], y1=irr.rep[,"upper"], length=0)
abline(h=1, lty=2, col='gray')
```

The association with cases, based on date of report, is less clean than the associations based on other outcomes. For example, the time series of proportion of tests that is positive is implicitly adjusted for variations in testing over time. The data on reported cases, however, is potentially subject to day-of-week effects and other reporting quirks. In this plot, the number of reported cases is colored based on the day of the week

```{r, eval=T}
ds3$dow <- weekdays(ds3$date)
plot(ds3$date,ds3$new.cases, col=as.factor(ds3$dow))
points(ds3$date,ds3$new.cases, type='l')

```

```{r, eval=F}
rw.x.rep <- lapply(mods.cases.rep,'[[','delta.dow')

matplot(rw.x.rep[[1]], type='l')
#matplot(W3.scale, add=T)
```







