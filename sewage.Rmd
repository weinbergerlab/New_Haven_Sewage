---
title: "sewage"
author: "Dan Weinberger"
date: "5/26/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(eivtools)
library(readxl)
library(reshape2)
library(HDInterval)
library(rjags)
library(xtable)
library(sas7bdat)

source('./Models/mod1.deriv.ar1.R')
source('./Models/mod2.dist.lag.alt2.R')


```

## Overview
This is a reanalysis of data examining increases in SARS-CoV-2 RNA concentrations in primary sewage sludge in relation to COVID-19 hospitalizations and cases. The original preprint, led by Jordan Peccia, et al can be found here: https://www.medrxiv.org/content/10.1101/2020.05.19.20105999v1 
The original pre-print included a correlation of smoothed versions of the viral RNA data and the epidemiological indicators. This ignores the uncertainty in both the X and Y variable. In the analyses presented here, we use an error-in-variables time series model to get an estimate of the underlying viral dynamics in sewage and the relationship of this with hospitalizations. This analysis is carried out in the Bayesian framework, allowing us to correctly quantify uncertainty in the estimated associations. The re-analysis was performed by Dan Weinberger (Epidemiology of Microbial Diseases, Yale School of Public Health), with input from Josh Warren (Biostatistics, Yale School of Public Health).

```{r, eval=F, include=F}
## Combine data (only need to do this once)

ds1 <- read_excel('./Data/raw RNA data.xlsx')
ds1.m <- melt(ds1, id.vars='DATE')
names(ds1.m) <- c('date', 'test','conc')



ds2 <- read.sas7bdat('./Data/dw1stpostest.sas7bdat')
ds2$date <-format(as.Date(ds2$newspecdate, origin="1960-01-01"),"%Y-%m-%d")

tests <- read.sas7bdat('./Data/dw1stcovtest.sas7bdat')
tests$date <-format(as.Date(tests$newspecdate, origin="1960-01-01"),"%Y-%m-%d")


ds2.nh <- ds2[ds2$OfficialCity %in% c('NEW HAVEN', 'EAST HAVEN','HAMDEN', 'WOODBRIDGE'),]
ds2.nh$cases <-1
ds2.nh.agg <- aggregate(ds2.nh[,'cases', drop=F],by=list('date'=ds2.nh$date), FUN=sum)
ds2.nh.agg$date <- as.Date(ds2.nh.agg$date)

tests.nh <- tests[tests$OfficialCity %in% c('NEW HAVEN', 'EAST HAVEN','HAMDEN', 'WOODBRIDGE'),]
tests.nh$cov.tests <-1
tests.nh.agg <- aggregate(tests.nh[,'cov.tests', drop=F],by=list('date'=tests.nh$date), FUN=sum)
tests.nh.agg$date <- as.Date(tests.nh.agg$date)


ds.hosp <- read_excel('./Data/epi.data.xlsx')
ds.hosp$date <- as.Date(ds.hosp$date)
ds1.m$date <- as.Date(ds1.m$date)

ds3 <- merge(ds2.nh.agg, ds1.m, by='date', all=T)
ds3 <- merge(ds3, tests.nh.agg, by='date', all=T)
ds3 <- merge(ds3, ds.hosp, by='date', all=T)
ds3$prop.pos <- ds3$cases/ds3$cov.tests
#plot(ds3$cases)
#points(ds3$new.cases)

ds3$conc <- as.numeric(ds3$conc)
ds3$target <- 'n1'
ds3$target[grep('n1', ds3$test)] <- 'n2'

write.csv(ds3,'./Data/combined.data.csv')
```


```{r}
## read in combined data

ds3 <- read.csv('./Data/combined.data.csv')
ds3$date <- as.Date(ds3$date)
```


## Plots of raw data

This shows that one of the PCR targets is consistently higher than the other--will need to adjust for this in the model
```{r, fig.width=4, fig.height=9}
par(mfrow=c(3,1))
plot(ds3$date, ds3$hospt_admit, type='l', bty='l', main='Hospitalizations')

# plot(ds3$date, ds3$new.cases, type='l', main='New reported cases')

plot(ds3$date, ds3$prop.pos, main='Proportion of human tests positive', xlab='Date', ylab='Proportion positive', bty='l')

plot(ds3$date, log(ds3$conc), main='Viral RNA in Sewage', col=as.factor(ds3$target), xlab='Date', ylab='Log Concentration')

```


```{r}
## Prepare data for JAGS

ds.mod <- ds3[!(is.nan(ds3$conc)),]
ds.mod <- ds.mod[!(is.na(ds.mod$conc)),]

ds.mod$log.conc <- as.vector(log(ds.mod$conc))

ds.mod.m <- melt(ds.mod[,c('date','test','log.conc','hospt_admit')], id.vars=c('date', 'test'))
ds.mod.c <- dcast(ds.mod.m, date~variable+test, fun.aggregate = mean)
W1 <- ds.mod.c[, grep('log.conc', names(ds.mod.c))] 
W1 <- apply(W1, 2, function(x){
  x[is.nan(x)] <-NA
  return(x)
} )

scale.W1 <- apply(W1,2, scale)
Y1 <- ds.mod.c[,'hospt_admit_rep1_n1']
Y1[is.nan(Y1)] <-NA

W1.scale <- apply(W1,2,scale)

log.offset.y1 <- rep(0, length(Y1))

```

## Model hospitalizations as a function of lags of viral RNA in sewage

```{r}
mod2 <- mod2.func(W=W1.scale, Y=Y1,log.offset=log.offset.y1)


```

Distributed lags for the association betwene viral RNA in sewage and COVID hospitalizations. This shows that lags of 1-4 days are associated with hospitalization. +/-90% Credible Intervals.

```{r}
yrange <- range(mod2$beta1)
plot(0:7, mod2$beta1$post_means, ylim=yrange, bty='l', ylab='Cumulative beta', xlab='Lag (days)' , pch=16)
arrows(x0=0:7, y0=mod2$beta1$lower, y1=mod2$beta1$upper, length=0)
abline(h=0)
```

Cumulative relationship between viral RNA in sewage and hospital admissions. This shows that lags of sewage data of 1-4 days together best correlate with the hospitalization time series. +/-90% Credible Intervals.

```{r}
yrange <- range(mod2$beta1.cum)
plot(0:7, mod2$beta1.cum$post_means, ylim=yrange, bty='l', ylab='Cumulative beta', xlab='Lag (days)', pch=16 )
arrows(x0=0:7, y0=mod2$beta1.cum$lower, y1=mod2$beta1.cum$upper, length=0)
abline(h=0)
```

Beta coefficients for viral RNA concentration in sewage at each lag
```{r, echo=F}
beta.format <- paste0(round(mod2$beta1[,1],2), ', (' , round(mod2$beta1[,2],2) , ',' , round(mod2$beta1[,3],2), ')'   )

beta.format<- cbind.data.frame('lag'=0:7, beta.format)
beta.format
```

This shows the viral concentration as measured by qPCR, smoothed with a random walk model. Each dot represents a separate qPCR run. For each time point, there were two targets tested, and 2 replicates of each. One of the targets is consistently higher, and this is adjusted for in the model. Lags of the random walk trajectory are used in the distributed lags model of hospitalizations.

```{r}
times <- 1:nrow(mod2$X)
yrange=range(c((W1.scale),(as.matrix(mod2$X ))), na.rm=T)
plot(times, (mod2$X[,1]), type='l', bty='l', ylim=yrange, ylab='Scaled-log-Viral concentration', lwd=2)
polygon(c(times, rev(times)),  c((mod2$X[,2]), rev((mod2$X[,3]))) ,col = rgb(0, 0, 1, alpha = 0.1), border = NA ) 

matplot((W1.scale), add=T, type='p')


```


## Smoothed curves of hospitalization and qPCR data
Note these are presented only for visualization purposes and are not used in the above analyses. Each curve is smoothed separately using an AR(1) random effect.
```{r, include=F}
## Smooth X and y separately
#These plots use a random walk, order 2 to smooth the qPCR data and hospitalization data for visualization
mod1 <- mod1.func(Y=Y1, W=scale.W1)
```

```{r, fig.width=4, fig.height=6, include=T}
par(mfrow=c(2,1), mar=c(2,4,1,1))
t <- 1:nrow(mod1$X1)
ylim1 <- range(c((mod1$X1),(scale.W1)), na.rm=T)
matplot(t, (mod1$X1), col='blue', main='Smoothed Viral concentration', type='l',lty=c(1,2,2), bty='l', ylim=ylim1, ylab='Logged and scaled Viral concentration')
matplot((scale.W1), add=T, type='p')

ylim2 <- range(c((mod1$lambda),Y1), na.rm=T)
matplot(t , (mod1$lambda), col='red', main='Smoothed Hospitalizations', type='l',lty=c(1,2,2), bty='l', ylim=ylim2)
matplot(Y1, add=T, type='p')

```


## Association of viral load with new cases. 
Seem to be some convergence issues with this model that need to be resolved, possibly due to missing case data at the start of the time series

```{r, eval=T}

#Note data on new cases are missing
#ds.mod.m <- melt(ds.mod[!is.na(ds.mod$new.cases),c('date','test','log.conc','new.cases')], id.vars=c('date', 'test'))
ds.mod.m <- melt(ds.mod[,c('date','test','log.conc','cases', 'cov.tests')], id.vars=c('date', 'test'))
ds.mod.c <- dcast(ds.mod.m, date~variable+test, fun.aggregate = mean)
W2 <- ds.mod.c[, grep('log.conc', names(ds.mod.c))] 
W2 <- apply(W2, 2, function(x){
  x[is.nan(x)] <-NA
  return(x)
} )
scale.W2 <- apply(W2, 2, scale)
Y2 <- ds.mod.c[,'cases_rep1_n1']
Y2[is.nan(Y2)] <-NA

log.offset2 <- log(ds.mod.c[,'cov.tests_rep1_n1'])
log.offset2[is.nan(log.offset2)] <-NA
log.offset2[is.na(log.offset2)] <-0
W2.scale <- apply(W2,2, scale)

```

```{r, eval=T}
mod2 <- mod2.func(W=W2.scale, log.offset=log.offset2,Y=Y2)


```

### Distributed lags for the association between viral RNA in sewage and COVID hospitalizations. This shows that lags longer lags are associated with cases time series (on the cumualative plot) +/-90% Credible Intervals.

```{r, eval=T}

yrange <- range(mod2$beta1)
plot(0:7, mod2$beta1$post_means, ylim=yrange, bty='l', ylab='Cumulative beta', xlab='Lag (days)' , pch=16)
arrows(x0=0:7, y0=mod2$beta1$lower, y1=mod2$beta1$upper, length=0)
abline(h=0)
```


```{r, eval=T}
#Cumulative relationship between viral RNA in sewage and new cases. This shows that lags of sewage data of 3-7 days together best correlate with the hospitalization time series. +/-90% Credible Intervals.

yrange <- range(mod2$beta1.cum)
plot(0:7, mod2$beta1.cum$post_means, ylim=yrange, bty='l', ylab='Cumulative beta', xlab='Lag (days)', pch=16 )
arrows(x0=0:7, y0=mod2$beta1.cum$lower, y1=mod2$beta1.cum$upper, length=0)
abline(h=0)
```

```{r}
lambda.prop <- apply(mod2$lambda,2,function(x) x/exp(log.offset2[-c(1:7)]))
matplot(lambda.prop, type='l')

#matplot(exp(mod2$X[-c(1:7),]), type='l')
```

### Beta coefficients for viral RNA concentration in sewage at each lag, as a correlate of new cases

```{r, echo=F, eval=T}

beta.format <- paste0(round(mod2$beta1[,1],2), ', (' , round(mod2$beta1[,2],2) , ',' , round(mod2$beta1[,3],2), ')'   )

beta.format<- cbind.data.frame('lag'=0:7, beta.format)
beta.format
```





